DIM A% 20
A%!0=&20B80002
A%!4=&0100007F
A%!8=0
A%!12=0

SYS "Socket_Creat",2,1,0 TO server%
SYS "Socket_Creat",2,1,0 TO client%

SYS "Socket_Bind",server%,A%,16
SYS "Socket_Listen",server%,4
SYS "Socket_Connect",client%,A%,16

SYS "Socket_Write",client%,A%,4
A%!16 = 16
SYS "Socket_Accept",server%,A%,A%+16 TO connected%
SYS "Socket_Read",connected%,A%,4

DIM event_handler% 16, registers% 64
P%=event_handler%
[
TEQ r0, #19
STMEQIA r12, {r0-r14}
MOV pc, r14
]
registers%!56=0
FOR I%=0 TO 56 STEP 4
registers%!I%=0
NEXT


SYS "OS_Claim",&10,event_handler%,registers%
*FX 14 19
!A%=1
SYS "Socket_Ioctl",client%,&8004667D,A%

SYS "Socket_Write",connected%,A%,4

TIME=0:REPEAT:UNTIL TIME>100

*FX 13 19
SYS "OS_Release",&10,event_handler%,registers%

PRINT "Server   ";server%
PRINT "Client   ";client%
PRINT "Accepted ";connected%

FOR I%=0 TO 14
PRINT I%, registers%!(I%*4), ~registers%!(I%*4)
NEXT

SYS "Socket_Close", server%
SYS "Socket_Close", client%
SYS "Socket_Close", connected%
